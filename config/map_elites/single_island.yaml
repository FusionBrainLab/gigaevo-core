# @package _global_

# Load problem context to extract metrics
problem_context:
  _target_: gigaevo.problems.context.ProblemContext
  problem_dir: ${problem.dir}

# Extract metrics context
metrics_context:
  _target_: gigaevo.config.helpers.get_metrics_context
  problem_context: ${problem_context}

# Compute primary key
primary_key:
  _target_: gigaevo.config.helpers.get_primary_key
  metrics_context: ${metrics_context}

# Compute higher_is_better
higher_is_better:
  _target_: gigaevo.config.helpers.is_higher_better
  metrics_context: ${metrics_context}
  key: ${primary_key}

# Compute bounds
primary_bounds:
  _target_: gigaevo.config.helpers.get_bounds
  metrics_context: ${metrics_context}
  key: ${primary_key}

validity_bounds:
  _target_: gigaevo.config.helpers.get_bounds
  metrics_context: ${metrics_context}
  key: ${constants.validity_key}

# Build behavior space from lists
behavior_space:
  _target_: gigaevo.config.helpers.build_behavior_space
  keys:
    - ${primary_key}
    - ${constants.validity_key}
  bounds:
    - ${primary_bounds}
    - ${validity_bounds}
  resolutions:
    - ${constants.primary_resolution}
    - ${constants.validity_resolution}
  binning_types:
    - ${constants.binning_type}
    - ${constants.binning_type}

# Islands
islands:
  - _target_: gigaevo.evolution.strategies.map_elites.IslandConfig
    island_id: ${constants.island_id}
    max_size: ${constants.island_max_size}
    behavior_space: ${behavior_space}
    archive_selector:
      _target_: gigaevo.evolution.strategies.map_elites.SumArchiveSelector
      fitness_keys:
        - ${primary_key}
      fitness_key_higher_is_better:
        - ${higher_is_better}
    elite_selector:
      _target_: gigaevo.evolution.strategies.map_elites.FitnessProportionalEliteSelector
      fitness_key: ${primary_key}
      fitness_key_higher_is_better: ${higher_is_better}
    archive_remover:
      _target_: gigaevo.evolution.strategies.map_elites.FitnessArchiveRemover
      fitness_key: ${primary_key}
      fitness_key_higher_is_better: ${higher_is_better}
    migrant_selector:
      _target_: gigaevo.evolution.strategies.map_elites.TopFitnessMigrantSelector
      fitness_key: ${primary_key}
      fitness_key_higher_is_better: ${higher_is_better}
    migration_rate: ${constants.migration_rate}

# Evolution strategy
evolution_strategy:
  _target_: gigaevo.evolution.strategies.map_elites.MapElitesMultiIsland
  island_configs: ${islands}
  program_storage: ${ref:redis_storage}
  migration_interval: ${constants.migration_interval}
  enable_migration: ${constants.enable_migration}
  max_migrants_per_island: ${constants.max_migrants_per_island}

# Mutation operator
mutation_operator:
  _target_: gigaevo.evolution.mutation.mutation_operator.LLMMutationOperator
  llm_wrapper: ${llm}
  mutation_mode: ${constants.mutation_mode}
  problem_context: ${problem_context}
